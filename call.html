<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nusuk – Web Call (Firebase + WebRTC)</title>
<style>
  :root{ --device-w:670px; --device-h:1000px; --chrome:10px; --glass:rgba(255,255,255,.12); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;display:grid;place-items:center;background:#f0f0f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .device{position:relative;width:var(--device-w);height:var(--device-h);background:#fff;border:var(--chrome) solid #cfcfcf;border-radius:28px;box-shadow:0 12px 28px rgba(0,0,0,.18),0 2px 4px rgba(0,0,0,.08);overflow:hidden}
  .statusbar{position:absolute;inset:0 0 auto 0;height:24px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:0 10px;font-size:13px;color:#000;z-index:5}
  .status-left{display:flex;align-items:center;gap:6px}
  .status-center{text-align:center;font-weight:700}
  .status-right{display:flex;justify-content:flex-end;align-items:center;gap:8px}
  .battery{width:24px;height:12px;border:2px solid #111;border-radius:3px;position:relative}
  .battery::after{content:"";position:absolute;right:-4px;top:3px;width:3px;height:6px;background:#111;border-radius:1px}
  .battery .level{width:70%;height:100%;background:#111;border-radius:1px}

  .screen{position:absolute;inset:24px 0 0 0;display:grid;grid-template-rows:auto 1fr;overflow:hidden;background:#000}
  .screen::before{content:"";position:absolute;inset:0;background:url('./1_Banner_7565e3bf83.jpg') center/cover no-repeat;filter:brightness(.72);transform:scale(1.02)}
  .screen::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,.15))}
  .topbar{position:relative;z-index:3;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:10px 12px;height:56px;color:#fff}
  .brand{display:flex;align-items:center;gap:8px;cursor:pointer}
  .brand img{width:100px;height:50px;display:block}
  .icon-btn{width:36px;height:36px;border:0;border-radius:10px;background:rgba(255,255,255,.14);display:grid;place-items:center;cursor:pointer;backdrop-filter:blur(6px)}
  .icon-btn svg{display:block}

  .wrap{position:relative;z-index:2;padding:12px;display:grid;gap:12px;grid-template-columns:1fr}
  .panel{width:min(760px,100%);margin:0 auto;background:var(--glass);border:1px solid rgba(255,255,255,.22);border-radius:18px;padding:16px;color:#fff;backdrop-filter:blur(10px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
  h2{margin:0 0 10px;font-size:20px}
  h3{margin:0 0 8px}
  .grid{display:grid;gap:10px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .controls{display:grid;grid-auto-flow:column;gap:8px;justify-content:start;align-items:center}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
  .btn.primary{background:#000;color:#fff}
  .btn.light{background:#fff;color:#000}
  .btn.warn{background:#b00020;color:#fff}
  .input,.ta,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.35);background:rgba(0,0,0,.25);color:#fff}
  .ta{min-height:44px;resize:vertical}
  label{font-size:12px;opacity:.9;margin-bottom:4px;display:block}
  .videos{position:relative;height:420px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.22);background:#111}
  video{width:100%;height:100%;object-fit:cover;background:#000}
  .pip{position:absolute;right:10px;bottom:10px;width:180px;height:120px;border-radius:12px;border:2px solid rgba(255,255,255,.5);overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.5)}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px}
  .muted{opacity:.85;font-size:12px}
  .toast{position:absolute;left:50%;top:84px;transform:translateX(-50%);z-index:6;background:#fff;color:#000;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s ease}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <div class="device">
    <div class="statusbar">
      <div class="status-left">
        <span>Batelco</span>
        <svg class="wifi" width="18" height="12" viewBox="0 0 24 14" aria-hidden="true">
          <path d="M2 5.5a16 16 0 0 1 20 0" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 9.5a10 10 0 0 1 12 0" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
          <path d="M10 12.5a4 4 0 0 1 4 0" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="status-center" id="bh-clock"></div>
      <div class="status-right"><div class="battery"><div class="level"></div></div></div>
    </div>

    <div class="screen">
      <div id="toast" class="toast">Ready</div>

      <header class="topbar" role="banner">
        <button id="backHome" class="icon-btn" aria-label="Back">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div id="logoHome" class="brand" aria-label="Nusuk logo">
          <img src="./logo.svg" alt="Nusuk" />
        </div>
        <button id="endCall" class="icon-btn" title="End call" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15s-3-3-9-3-9 3-9 3l3 3 3-3"/>
          </svg>
        </button>
      </header>

      <main class="wrap">
        <section class="panel grid">
          <h2>Web Call (Firebase + WebRTC)</h2>
          <div class="videos">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" class="pip" autoplay muted playsinline></video>
          </div>

          <div class="panel" style="background:rgba(0,0,0,.18)">
            <h3 style="margin-top:0">Controls</h3>
            <div class="controls">
              <label><input type="checkbox" id="useVideo" checked /> Video</label>
              <label><input type="checkbox" id="useAudio" checked /> Audio</label>
              <button class="btn light" id="startMedia">Start Camera</button>
              <button class="btn" id="toggleMic" disabled>Mute</button>
              <button class="btn" id="toggleCam" disabled>Camera Off</button>
              <button class="btn" id="shareScreen" disabled>Share Screen</button>
            </div>
            <p class="muted" style="margin-top:8px">Works over HTTPS (GitHub Pages is OK). For toughest networks, add a TURN server in code.</p>
          </div>

          <div class="grid-2">
            <div class="panel" style="background:rgba(0,0,0,.18)">
              <h3 style="margin-top:0">Create Room (Host)</h3>
              <div class="row">
                <input id="roomIdOut" class="input" readonly placeholder="Room ID will appear here" />
                <button class="btn primary" id="createRoom" disabled>Create Room</button>
              </div>
              <p class="muted">Share the Room ID with the other user.</p>
            </div>

            <div class="panel" style="background:rgba(0,0,0,.18)">
              <h3 style="margin-top:0">Join Room (Guest)</h3>
              <div class="row">
                <input id="roomIdIn" class="input" placeholder="Enter Room ID" />
                <button class="btn light" id="joinRoom">Join</button>
              </div>
            </div>
          </div>

          <div class="controls" style="justify-content:space-between">
            <button class="btn warn" id="hangup" disabled>Hang Up</button>
            <button class="btn light" id="goHomeBtn">Back to Home</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // --- Bahrain clock ---
  (function(){
    const el=document.getElementById('bh-clock'); if(!el) return; const tz='Asia/Bahrain';
    function tick(){ const now=new Date(); const time=new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:tz}).format(now); el.textContent=time; el.title=new Intl.DateTimeFormat('en-US',{weekday:'short',month:'short',day:'numeric',timeZone:tz}).format(now);} tick(); setInterval(tick,30000);
  })();

  // --- Navigation ---
  const goHome = ()=> location.href = './index.html';
  document.getElementById('backHome').addEventListener('click', goHome);
  document.getElementById('logoHome').addEventListener('click', goHome);
  document.getElementById('goHomeBtn').addEventListener('click', goHome);

  // --- Toast ---
  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }

  // ===== 1) Firebase setup =====
  const firebaseConfig = {
    // TODO: paste your Firebase web app config here:
    // apiKey: "…",
    // authDomain: "…",
    // projectId: "…",
    // storageBucket: "…",
    // messagingSenderId: "…",
    // appId: "…"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== 2) WebRTC setup =====
  let pc, localStream, screenStream, roomRef, callerCandidatesCollection, calleeCandidatesCollection, unsubRoom;

  const iceServers = [
    { urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302','stun:stun2.l.google.com:19302'] },
    // Strongly recommended: add your TURN server here (Twilio, coturn, etc.)
    // { urls: 'turn:YOUR_TURN_HOST:3478', username: 'TURN_USER', credential: 'TURN_PASS' }
  ];

  function ensurePC(){
    if (pc) return pc;
    pc = new RTCPeerConnection({ iceServers });
    pc.ontrack = (e)=>{ const rv=document.getElementById('remoteVideo'); if(rv.srcObject!==e.streams[0]) rv.srcObject=e.streams[0]; };
    pc.onconnectionstatechange = ()=>{
      if(pc.connectionState==='connected'){ toast('Connected'); setButtonsConnected(true); }
      if(['disconnected','failed','closed'].includes(pc.connectionState)){ toast('Disconnected'); setButtonsConnected(false); }
    };
    pc.onicecandidate = (event)=>{
      if (event.candidate && callerCandidatesCollection) {
        callerCandidatesCollection.add(event.candidate.toJSON());
      } else if (event.candidate && calleeCandidatesCollection) {
        calleeCandidatesCollection.add(event.candidate.toJSON());
      }
    };
    return pc;
  }

  function setButtonsConnected(connected){
    document.getElementById('hangup').disabled = !connected;
    document.getElementById('endCall').disabled = !connected;
  }

  // ===== 3) Media controls =====
  const useVideo = document.getElementById('useVideo');
  const useAudio = document.getElementById('useAudio');
  const startMediaBtn = document.getElementById('startMedia');
  const toggleMicBtn = document.getElementById('toggleMic');
  const toggleCamBtn = document.getElementById('toggleCam');
  const shareBtn = document.getElementById('shareScreen');

  const localVideo = document.getElementById('localVideo');
  async function startMedia(){
    try{
      if(localStream) return;
      const constraints = { video: useVideo.checked, audio: useAudio.checked };
      if(!constraints.video && !constraints.audio){ alert('Enable Video or Audio'); return; }
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      localVideo.srcObject = localStream;
      const peer = ensurePC();
      localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
      document.getElementById('createRoom').disabled = false;
      toggleMicBtn.disabled = !constraints.audio ? true : false;
      toggleCamBtn.disabled = !constraints.video ? true : false;
      shareBtn.disabled = false;
      toast('Camera/Mic ready');
    }catch(err){ alert('Error accessing media: ' + err.message); }
  }
  startMediaBtn.addEventListener('click', startMedia);

  function toggleMic(){
    if(!localStream) return;
    localStream.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
    const on = localStream.getAudioTracks().some(t=>t.enabled);
    toggleMicBtn.textContent = on ? 'Mute' : 'Unmute';
  }
  function toggleCam(){
    if(!localStream) return;
    localStream.getVideoTracks().forEach(t=>t.enabled=!t.enabled);
    const on = localStream.getVideoTracks().some(t=>t.enabled);
    toggleCamBtn.textContent = on ? 'Camera Off' : 'Camera On';
  }
  async function shareScreenStart(){
    try{
      screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
      const screenTrack = screenStream.getVideoTracks()[0];
      const sender = ensurePC().getSenders().find(s=>s.track && s.track.kind==='video');
      if(sender) await sender.replaceTrack(screenTrack);
      screenTrack.onended = async ()=>{
        const camTrack = localStream?.getVideoTracks()[0];
        if(camTrack && sender) await sender.replaceTrack(camTrack);
      };
      toast('Sharing screen');
    }catch(e){ /* cancelled */ }
  }
  toggleMicBtn.addEventListener('click', toggleMic);
  toggleCamBtn.addEventListener('click', toggleCam);
  shareBtn.addEventListener('click', shareScreenStart);

  // ===== 4) Create room (host) =====
  const createRoomBtn = document.getElementById('createRoom');
  const roomIdOut = document.getElementById('roomIdOut');
  createRoomBtn.addEventListener('click', async ()=>{
    if(!localStream) await startMedia();
    const peer = ensurePC();

    roomRef = await db.collection('rooms').add({ createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    roomIdOut.value = roomRef.id;

    callerCandidatesCollection = roomRef.collection('callerCandidates');

    // Offer
    const offer = await peer.createOffer({offerToReceiveAudio:true, offerToReceiveVideo:true});
    await peer.setLocalDescription(offer);
    await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } }, { merge: true });

    // Listen for remote answer
    unsubRoom = roomRef.onSnapshot(async snap=>{
      const data = snap.data();
      if (!peer.currentRemoteDescription && data?.answer) {
        await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    // Listen for callee ICE
    roomRef.collection('calleeCandidates').onSnapshot(snap=>{
      snap.docChanges().forEach(change=>{
        if(change.type === 'added'){
          let candidate = new RTCIceCandidate(change.doc.data());
          peer.addIceCandidate(candidate).catch(()=>{});
        }
      });
    });

    toast('Room created. Share Room ID.');
  });

  // ===== 5) Join room (guest) =====
  const joinRoomBtn = document.getElementById('joinRoom');
  const roomIdIn = document.getElementById('roomIdIn');
  joinRoomBtn.addEventListener('click', async ()=>{
    const id = roomIdIn.value.trim();
    if(!id){ alert('Enter Room ID'); return; }
    if(!localStream) await startMedia();

    roomRef = db.collection('rooms').doc(id);
    const roomSnap = await roomRef.get();
    if(!roomSnap.exists){ alert('Room not found'); return; }

    calleeCandidatesCollection = roomRef.collection('calleeCandidates');

    const peer = ensurePC();

    // Listen for caller ICE
    roomRef.collection('callerCandidates').onSnapshot(snap=>{
      snap.docChanges().forEach(change=>{
        if(change.type === 'added'){
          let candidate = new RTCIceCandidate(change.doc.data());
          peer.addIceCandidate(candidate).catch(()=>{});
        }
      });
    });

    const offer = roomSnap.data().offer;
    await peer.setRemoteDescription(new RTCSessionDescription(offer));

    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

    toast('Joined room. Connecting…');
  });

  // ===== 6) Hang up / cleanup =====
  const hangupBtn = document.getElementById('hangup');
  const endBtn = document.getElementById('endCall');
  async function hangup(){
    try{ screenStream?.getTracks().forEach(t=>t.stop()); }catch{}
    try{ localStream?.getTracks().forEach(t=>t.stop()); }catch{}
    try{ pc?.getSenders().forEach(s=>s.track && s.track.stop()); }catch{}
    try{ pc?.close(); }catch{}
    pc=null; localStream=null; screenStream=null;

    // Optional: delete room & candidates to keep DB clean
    if(roomRef){
      const snap = await roomRef.get();
      if(snap.exists){
        const cCand = await roomRef.collection('callerCandidates').get();
        cCand.forEach(doc=>doc.ref.delete());
        const dCand = await roomRef.collection('calleeCandidates').get();
        dCand.forEach(doc=>doc.ref.delete());
        await roomRef.delete().catch(()=>{});
      }
    }
    if (unsubRoom) { unsubRoom(); unsubRoom=null; }
    setButtonsConnected(false);
    toast('Call ended');
  }
  hangupBtn.addEventListener('click', hangup);
  endBtn.addEventListener('click', hangup);

  // Enable hangup when connected
  function setButtonsConnected(connected){
    document.getElementById('hangup').disabled = !connected;
    document.getElementById('endCall').disabled = !connected;
  }

  // Enable create room once media is available
  // (Auto-start media if you prefer)
  // startMedia();
</script>
</body>
</html>
